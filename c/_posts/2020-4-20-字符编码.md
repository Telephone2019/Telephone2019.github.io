---
layout: post
title: 字符编码
description: >
  什么是字符编码？为什么会出现乱码？在C语言中，关于字符编码我们需要知道些什么？
image: /assets/img/blog/example-content-ii.jpg
noindex: true
---

## 前言

你是否遇到过这种情况：

```c
#include <stdio.h>
#include <stdlib.h>

int main(void)
{
    printf("Hello, world!\n");   //鎴戠殑绗竴涓▼搴
    printf("鎴戞槸灏忔槑\n");
    system("pause");
    return 0;
}
```

或这种：

```
Hello, world!
浣犲ソ锛屼笘鐣岋紒
```

还有这种：

```
abcdef烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫
```

以及这种：

```
123456屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯
```

遇到了并不可怕，可怕的是你以为你的计算机真的很烫，甚至还一把拔掉了电源。

其实，造成以上几种情况的罪魁祸首都是 —— 字符编码。

## 机器处理的数据由 0 和 1 组成

相信大家对计算机世界中的 0 和 1 已经非常熟悉了。没错，计算机的世界其实就是 0 和 1 的世界。

作为程序员，尽管我们可以用各种各样的高级语言来编写我们的程序，但殊途同归的是，我们的程序在被计算机执行前，都会被转换成机器指令码，存放到**二进制文件**中。

> ***机器指令码：***也叫`机器语言`，是计算机能够理解并执行的指令。机器指令码用`二进制编码`表示。
>
> ***二进制编码：***0 和 1 的序列
>
> ***机器语言：***计算机唯一能识别并执行的编程语言
>
> ***二进制文件：***用于存储机器指令码的文件

当我们编写一个程序来解决一类问题时，从计算机的角度来看，程序的执行经历了3个过程：

1. 输入数据
2. 处理数据
3. 输出数据

由于计算机唯一能识别并执行的编程语言是`机器语言`，这3个过程可以看作：

1. 输入二进制编码
2. 处理二进制编码
3. 输出二进制编码

这就是今天的主角 —— `字符编码`产生的背景。

## 由文字到二进制编码

既然机器处理的数据都是由 0 和 1 组成的，那么……

> 老师：问题来了，如果计算机只认识 0 和 1，想要让计算机帮忙处理文字怎么办？
>
> 甲同学：重新买一台认识文字的计算机
>
> 乙同学：那还不简单？把文字转换成 0 和 1 不就行了吗？
>
> 丙同学：可以用二进制数表示文字，一个二进制数对应一个字，比如 ‘我’ 对应 0，‘你’ 对应 1，‘他’ 对应 10，‘他们’ 对应11......以此类推
>
> 老师：......

丙同学提出的办法看起来十分不错：

> 0 → 我
>
> 1 → 你
>
> 10 → 他
>
> 11 → 他们
>
> ......

让我们试着完善一下丙同学的方案：

> 1. 假设计算机需要处理的文字仅包括：
>
> 	- 26个小写英文字母
> 	- 26个大写英文字母
> 	- 英文逗号`,`
> 	- 英文句点`.`
> 	- 英文感叹号`!`
>
> 	我们把由计算机需要处理的文字组成的集合称为`字符集`，暂且把这 55 个文字组成的字符集取名为 `Mini` 字符集
>
> 2. 确定了字符集，我们现在唯一要做的就是确定一种**方案**，把字符集中的文字与二进制数一一对应起来。这种把`字符集`中的字符映射为二进制编码的方案称为`字符编码方案`，映射得到的二进制编码称为`字符编码`
>
> 3. 我们采取最简单而直观的一种方案 —— 从 0 开始按照一定的顺序给字符集中的文字编号，然后把编号的二进制形式作为字符编码
>
> 	```
> 	1. 首先，把 Mini 字符集中的文字按照 <a-z、A-Z、逗号、句号、感叹号> 的顺序排好序
> 	2. 把字母 a 的编号设为 0，从 a 到 ! 编号递增，感叹号 ! 的编号是 54
> 	3. 如此，字母 a 的字符编码是 0，感叹号 ! 的字符编码是 110110
> 	```
>
> 4. 我们把这种字符编码方案命名为 `Mini-Simple` 编码方案

到现在为止，我们确定了 `Mini` 字符集，还确定基于 Mini 字符集的一种字符编码方案 —— `Mini-Simple` 编码方案

按照 Mini-Simple 字符编码方案，如果想让计算机逆序输出 `Hello,world!`这句话，那么程序输入输出的二进制数据应该是：

> 输入（文字）：`Hello,world!`
>
> 输入（编号）：33 4 11 11 14 52 22 14 17 11 3 54
>
> 输入（字符编码）：100001 100 1011 1011 1110 110100 10110 1110 10001 1011 11 110110

> 输出（字符编码）：110110 11 1011 10001 1110 10110 110100 1110 1011 1011 100 100001
>
> 输出（编号）：54 3 11 17 14 22 52 14 11 11 4 33
>
> 输出（文字）：`!dlrow,olleH`

## 小结

综合上述，我们可以整理出以下概念：

> ***字符集：***需要编码成`二进制`的字符组成的集合
>
> ***字符编码方案：***把特定`字符集`中的字符编码成二进制的方案
>
> ***字符编码：***字符编码有两个含义：
>
> - 指按照特定`字符编码方案`把字符编码成二进制的**过程**
> - 指按照特定`字符编码方案`把字符编码成二进制所得到**二进制编码**，也叫**字集码**
>
> ***字符解码：***按照特定`字符编码方案`把二进制编码解码成字符的过程

以上概念有几点需要注意：

> 1. `字符编码方案`基于`字符集`
> 2. 当提到字符编码时，一般只会提**字符编码方案**，因为`字符集`和`字符编码方案`是一对多的关系，通过唯一的`字符编码方案`能够确定唯一的`字符集`，但通过唯一的`字符集`不能确定唯一的`字符编码方案`
> 3. 一种字符编码方案应该保证：字符集中不同的字符按照此方案编码后得到的二进制编码不相同

## 常见的字符集与字符编码方案

下面介绍几种常见的字符编码方案。

## 标准ASCII

ASCII（(American Standard Code for Information Interchange): 美国信息交换标准代码）是基于拉丁字母的一种字符编码方案，主要用于编码英语和西欧语言。

标准 ASCII 是最通用的字符编码方案，**等同于国际标准 ISO/IEC 646**。

标准 ASCII 基于由128个字符构成的字符集，字符集中的字符由 ASCII 标准规定，包括：

- 控制字符
- 通信专用字符
- 空格
- 阿拉伯数字
- 大小写英文字母
- 标点符号
- 运算符号

标准 ASCII 的编码方式类似于 Mini-Simple 字符编码方案，采取 `字符——编号——编码`的方式。

ASCII 标准中规定，用标准 ASCII 编码的字符的字符编码用 7 位二进制数的组合表示。在使用标准 ASCII 时，会在字符编码的最高位补0使之成为一个字节（一个字节通常是 8 位二进制）。

以下是标准 ASCII 码表：

| Bin(二进制) | Oct(八进制) | Dec(十进制) | Hex(十六进制) | 缩写/字符                   | 解释         |
| ----------- | ----------- | ----------- | ------------- | --------------------------- | ------------ |
| 0000 0000   | 00          | 0           | 0x00          | NUL(null)                   | 空字符       |
| 0000 0001   | 01          | 1           | 0x01          | SOH(start of headline)      | 标题开始     |
| 0000 0010   | 02          | 2           | 0x02          | STX (start of text)         | 正文开始     |
| 0000 0011   | 03          | 3           | 0x03          | ETX (end of text)           | 正文结束     |
| 0000 0100   | 04          | 4           | 0x04          | EOT (end of transmission)   | 传输结束     |
| 0000 0101   | 05          | 5           | 0x05          | ENQ (enquiry)               | 请求         |
| 0000 0110   | 06          | 6           | 0x06          | ACK (acknowledge)           | 收到通知     |
| 0000 0111   | 07          | 7           | 0x07          | BEL (bell)                  | 响铃         |
| 0000 1000   | 010         | 8           | 0x08          | BS (backspace)              | 退格         |
| 0000 1001   | 011         | 9           | 0x09          | HT (horizontal tab)         | 水平制表符   |
| 0000 1010   | 012         | 10          | 0x0A          | LF (NL line feed, new line) | 换行键       |
| 0000 1011   | 013         | 11          | 0x0B          | VT (vertical tab)           | 垂直制表符   |
| 0000 1100   | 014         | 12          | 0x0C          | FF (NP form feed, new page) | 换页键       |
| 0000 1101   | 015         | 13          | 0x0D          | CR (carriage return)        | 回车键       |
| 0000 1110   | 016         | 14          | 0x0E          | SO (shift out)              | 不用切换     |
| 0000 1111   | 017         | 15          | 0x0F          | SI (shift in)               | 启用切换     |
| 0001 0000   | 020         | 16          | 0x10          | DLE (data link escape)      | 数据链路转义 |
| 0001 0001   | 021         | 17          | 0x11          | DC1 (device control 1)      | 设备控制1    |
| 0001 0010   | 022         | 18          | 0x12          | DC2 (device control 2)      | 设备控制2    |
| 0001 0011   | 023         | 19          | 0x13          | DC3 (device control 3)      | 设备控制3    |
| 0001 0100   | 024         | 20          | 0x14          | DC4 (device control 4)      | 设备控制4    |
| 0001 0101   | 025         | 21          | 0x15          | NAK (negative acknowledge)  | 拒绝接收     |
| 0001 0110   | 026         | 22          | 0x16          | SYN (synchronous idle)      | 同步空闲     |
| 0001 0111   | 027         | 23          | 0x17          | ETB (end of trans. block)   | 结束传输块   |
| 0001 1000   | 030         | 24          | 0x18          | CAN (cancel)                | 取消         |
| 0001 1001   | 031         | 25          | 0x19          | EM (end of medium)          | 媒介结束     |
| 0001 1010   | 032         | 26          | 0x1A          | SUB (substitute)            | 代替         |
| 0001 1011   | 033         | 27          | 0x1B          | ESC (escape)                | 换码(溢出)   |
| 0001 1100   | 034         | 28          | 0x1C          | FS (file separator)         | 文件分隔符   |
| 0001 1101   | 035         | 29          | 0x1D          | GS (group separator)        | 分组符       |
| 0001 1110   | 036         | 30          | 0x1E          | RS (record separator)       | 记录分隔符   |
| 0001 1111   | 037         | 31          | 0x1F          | US (unit separator)         | 单元分隔符   |
| 0010 0000   | 040         | 32          | 0x20          | (space)                     | 空格         |
| 0010 0001   | 041         | 33          | 0x21          | !                           | 叹号         |
| 0010 0010   | 042         | 34          | 0x22          | "                           | 双引号       |
| 0010 0011   | 043         | 35          | 0x23          | #                           | 井号         |
| 0010 0100   | 044         | 36          | 0x24          | $                           | 美元符       |
| 0010 0101   | 045         | 37          | 0x25          | %                           | 百分号       |
| 0010 0110   | 046         | 38          | 0x26          | &                           | 和号         |
| 0010 0111   | 047         | 39          | 0x27          | '                           | 闭单引号     |
| 0010 1000   | 050         | 40          | 0x28          | (                           | 开括号       |
| 0010 1001   | 051         | 41          | 0x29          | )                           | 闭括号       |
| 0010 1010   | 052         | 42          | 0x2A          | *                           | 星号         |
| 0010 1011   | 053         | 43          | 0x2B          | +                           | 加号         |
| 0010 1100   | 054         | 44          | 0x2C          | ,                           | 逗号         |
| 0010 1101   | 055         | 45          | 0x2D          | -                           | 减号/破折号  |
| 0010 1110   | 056         | 46          | 0x2E          | .                           | 句号         |
| 0010 1111   | 057         | 47          | 0x2F          | /                           | 斜杠         |
| 0011 0000   | 060         | 48          | 0x30          | 0                           | 字符0        |
| 0011 0001   | 061         | 49          | 0x31          | 1                           | 字符1        |
| 0011 0010   | 062         | 50          | 0x32          | 2                           | 字符2        |
| 0011 0011   | 063         | 51          | 0x33          | 3                           | 字符3        |
| 0011 0100   | 064         | 52          | 0x34          | 4                           | 字符4        |
| 0011 0101   | 065         | 53          | 0x35          | 5                           | 字符5        |
| 0011 0110   | 066         | 54          | 0x36          | 6                           | 字符6        |
| 0011 0111   | 067         | 55          | 0x37          | 7                           | 字符7        |
| 0011 1000   | 070         | 56          | 0x38          | 8                           | 字符8        |
| 0011 1001   | 071         | 57          | 0x39          | 9                           | 字符9        |
| 0011 1010   | 072         | 58          | 0x3A          | :                           | 冒号         |
| 0011 1011   | 073         | 59          | 0x3B          | ;                           | 分号         |
| 0011 1100   | 074         | 60          | 0x3C          | <                           | 小于         |
| 0011 1101   | 075         | 61          | 0x3D          | =                           | 等号         |
| 0011 1110   | 076         | 62          | 0x3E          | >                           | 大于         |
| 0011 1111   | 077         | 63          | 0x3F          | ?                           | 问号         |
| 0100 0000   | 0100        | 64          | 0x40          | @                           | 电子邮件符号 |
| 0100 0001   | 0101        | 65          | 0x41          | A                           | 大写字母A    |
| 0100 0010   | 0102        | 66          | 0x42          | B                           | 大写字母B    |
| 0100 0011   | 0103        | 67          | 0x43          | C                           | 大写字母C    |
| 0100 0100   | 0104        | 68          | 0x44          | D                           | 大写字母D    |
| 0100 0101   | 0105        | 69          | 0x45          | E                           | 大写字母E    |
| 0100 0110   | 0106        | 70          | 0x46          | F                           | 大写字母F    |
| 0100 0111   | 0107        | 71          | 0x47          | G                           | 大写字母G    |
| 0100 1000   | 0110        | 72          | 0x48          | H                           | 大写字母H    |
| 0100 1001   | 0111        | 73          | 0x49          | I                           | 大写字母I    |
| 01001010    | 0112        | 74          | 0x4A          | J                           | 大写字母J    |
| 0100 1011   | 0113        | 75          | 0x4B          | K                           | 大写字母K    |
| 0100 1100   | 0114        | 76          | 0x4C          | L                           | 大写字母L    |
| 0100 1101   | 0115        | 77          | 0x4D          | M                           | 大写字母M    |
| 0100 1110   | 0116        | 78          | 0x4E          | N                           | 大写字母N    |
| 0100 1111   | 0117        | 79          | 0x4F          | O                           | 大写字母O    |
| 0101 0000   | 0120        | 80          | 0x50          | P                           | 大写字母P    |
| 0101 0001   | 0121        | 81          | 0x51          | Q                           | 大写字母Q    |
| 0101 0010   | 0122        | 82          | 0x52          | R                           | 大写字母R    |
| 0101 0011   | 0123        | 83          | 0x53          | S                           | 大写字母S    |
| 0101 0100   | 0124        | 84          | 0x54          | T                           | 大写字母T    |
| 0101 0101   | 0125        | 85          | 0x55          | U                           | 大写字母U    |
| 0101 0110   | 0126        | 86          | 0x56          | V                           | 大写字母V    |
| 0101 0111   | 0127        | 87          | 0x57          | W                           | 大写字母W    |
| 0101 1000   | 0130        | 88          | 0x58          | X                           | 大写字母X    |
| 0101 1001   | 0131        | 89          | 0x59          | Y                           | 大写字母Y    |
| 0101 1010   | 0132        | 90          | 0x5A          | Z                           | 大写字母Z    |
| 0101 1011   | 0133        | 91          | 0x5B          | [                           | 开方括号     |
| 0101 1100   | 0134        | 92          | 0x5C          | \                           | 反斜杠       |
| 0101 1101   | 0135        | 93          | 0x5D          | ]                           | 闭方括号     |
| 0101 1110   | 0136        | 94          | 0x5E          | ^                           | 脱字符       |
| 0101 1111   | 0137        | 95          | 0x5F          | _                           | 下划线       |
| 0110 0000   | 0140        | 96          | 0x60          | `                           | 开单引号     |
| 0110 0001   | 0141        | 97          | 0x61          | a                           | 小写字母a    |
| 0110 0010   | 0142        | 98          | 0x62          | b                           | 小写字母b    |
| 0110 0011   | 0143        | 99          | 0x63          | c                           | 小写字母c    |
| 0110 0100   | 0144        | 100         | 0x64          | d                           | 小写字母d    |
| 0110 0101   | 0145        | 101         | 0x65          | e                           | 小写字母e    |
| 0110 0110   | 0146        | 102         | 0x66          | f                           | 小写字母f    |
| 0110 0111   | 0147        | 103         | 0x67          | g                           | 小写字母g    |
| 0110 1000   | 0150        | 104         | 0x68          | h                           | 小写字母h    |
| 0110 1001   | 0151        | 105         | 0x69          | i                           | 小写字母i    |
| 0110 1010   | 0152        | 106         | 0x6A          | j                           | 小写字母j    |
| 0110 1011   | 0153        | 107         | 0x6B          | k                           | 小写字母k    |
| 0110 1100   | 0154        | 108         | 0x6C          | l                           | 小写字母l    |
| 0110 1101   | 0155        | 109         | 0x6D          | m                           | 小写字母m    |
| 0110 1110   | 0156        | 110         | 0x6E          | n                           | 小写字母n    |
| 0110 1111   | 0157        | 111         | 0x6F          | o                           | 小写字母o    |
| 0111 0000   | 0160        | 112         | 0x70          | p                           | 小写字母p    |
| 0111 0001   | 0161        | 113         | 0x71          | q                           | 小写字母q    |
| 0111 0010   | 0162        | 114         | 0x72          | r                           | 小写字母r    |
| 0111 0011   | 0163        | 115         | 0x73          | s                           | 小写字母s    |
| 0111 0100   | 0164        | 116         | 0x74          | t                           | 小写字母t    |
| 0111 0101   | 0165        | 117         | 0x75          | u                           | 小写字母u    |
| 0111 0110   | 0166        | 118         | 0x76          | v                           | 小写字母v    |
| 0111 0111   | 0167        | 119         | 0x77          | w                           | 小写字母w    |
| 0111 1000   | 0170        | 120         | 0x78          | x                           | 小写字母x    |
| 0111 1001   | 0171        | 121         | 0x79          | y                           | 小写字母y    |
| 0111 1010   | 0172        | 122         | 0x7A          | z                           | 小写字母z    |
| 0111 1011   | 0173        | 123         | 0x7B          | {                           | 开花括号     |
| 0111 1100   | 0174        | 124         | 0x7C          | \|                          | 垂线         |
| 0111 1101   | 0175        | 125         | 0x7D          | }                           | 闭花括号     |
| 0111 1110   | 0176        | 126         | 0x7E          | ~                           | 波浪号       |
| 0111 1111   | 0177        | 127         | 0x7F          | DEL (delete)                | 删除         |

## 扩展 ASCII

扩展 ASCII 是对标准 ASCII 的扩展，它对标准 ASCII 作了如下扩展：

> 1. 字符集扩展到 **256** 个字符，前128个字符是标准 ASCII 中规定的字符，后128个字符是扩展的字符
> 2. 字符编码用 **8** 位二进制数的组合表示，如果一个字节的长度大于 8 位二进制，使用扩展 ASCII 时会在字符编码的最高位补0使之成为一个字节（一个字节通常是 8 位二进制）。

扩展 ASCII 是一类字符编码方案的总称，在不同的国家和地区，扩展 ASCII 可能对应不同的字符编码方案，这是由于不同的国家和地区所规定的后128个扩展字符可能不同。

## ANSI

类似于扩展 ASCII，ANSI 是一类字符编码方案的总称。

所有兼容 **标准 ASCII** 编码方案的字符编码方案都是 ANSI 编码方案。下面即将介绍的 GBK 编码方案、UTF-8 编码方案都是 ANSI 编码。而 UTF-16 编码方案就不是 ANSI 编码。

> **兼容标准 ASCII 编码方案**指的是：
>
> 1. 字符集包含 ASCII 标准中规定的128个字符
> 2. 对于在标准 ASCII 中定义的字符，用**一个字节**表示其字符编码，且其字符编码与使用 **标准 ASCII** 编码的结果完全一致

由于标准 ASCII 是最通用的字符编码方案，在实际运用中，使用非 ANSI 编码会造成许多不便，因此 ANSI 编码比非 ANSI 编码要流行的多

在使用 ANSI 编码时，只要仅使用标准 ASCII 中定义的字符，就能够获得最大的通用性，因为在这种情况下，一台计算机只要支持任意一种 ANSI 编码，它就能解读所有使用其他 ANSI 编码的字符

## GBK

GBK全称《汉字内码扩展规范》（GBK即“国标”、“扩展”汉语拼音的第一个字母），是中国大陆最通用的中文字符编码方案。

GBK 兼容 GB 2313 字符编码方案，收录了更多的汉字。同时，GBK 是 ANSI 编码。

GBK 字符编码方案基于 GBK 字符集（也称 GBK 字库），GBK 字库的定义范围可在中国技监标函1995 229号文件中查询到。

GBK 编码方案采用**单双字节变长编码**方式：

- 对于在标准 ASCII 中定义的字符以及部分其他字符，采取**单字节**编码方式
- 对于大部分中文字符以及部分其他字符，采取**双字节**编码方式。

## Unicode

Unicode（统一码、万国码、单一码）是计算机科学领域里的一项业界标准，包括字符集、编码方案等。

Unicode 是为了解决传统的字符编码方案的局限而产生的，它旨在为每种语言中的每个字符设定了统一并且唯一的二进制编码，以满足跨语言、跨平台进行文本转换、处理的要求。

Unicode 标准包括唯一的 Unicode 字符集，以及 UTF-8、UTF-16、UTF-32 三种基于 Unicode 字符集的编码方案。

## Unicode 字符集

Unicode 字符集包括了世界上各个国家和地区使用的绝大部分的字符。

按照 Unicode 标准，Unicode 字符集能够容纳 1114112 个字符，即 Unicode 字符集拥有 1114112 个`码位`。

按照标准，Unicode 字符集被划分为十七个平面，每个平面拥有 65536 个码位。目前只用了少数的平面。其中，**0号平面**（也叫基本多文种平面，Basic Multilingual Plane，BMP）最为重要，存放着当今世界上各个国家和地区正在使用的大部分字符。

按照标准，从 0 号平面（BMP）的第一个码位到 16 号平面的最后一个码位，每个码位都有唯一的 Unicode 编号，编号范围对应从 0x0000 到 0x10FFFF。Unicode 编号又叫 **Unicode 码点**。

## UTF-8 字符编码方案

UTF-8 字符编码方案基于 Unicode 字符集。

UTF-8 属于 ANSI 编码，同时也是一种变长编码方案，对于 Unicode 编号位于不同范围的字符，字符编码的长度是1~4字节不等。

从 Unicode 编号到 UTF-8 编码的对照表如下：

| **Unicode 编号(十六进制)** | **UTF-8 编码字节流(二进制)**        |
| -------------------------- | ----------------------------------- |
| 000000-00007F              | 0xxxxxxx                            |
| 000080-0007FF              | 110xxxxx 10xxxxxx                   |
| 000800-00FFFF              | 1110xxxx 10xxxxxx 10xxxxxx          |
| 010000-10FFFF              | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx |

## 字节序

UTF-8、UTF-16、UTF-32 字符编码方案的字符编码以字节为基本单位。

对于多字节的字符编码，存在一个令人困惑的问题。以“汉”字为例，“汉”的 Unicode 编号是 0x6C49：

| **Unicode编号** | **UTF-8（二进制）**        | **UTF-16（二进制）** | **UTF32（二进制）**                 |
| --------------- | -------------------------- | -------------------- | ----------------------------------- |
| 0x006C49        | 11100110 10110001 10001001 | 0‭1101100 01001001‬    | 00000000 00000000 0‭1101100 01001001‬ |

| **Unicode编号** | **UTF-8（十六进制）** | **UTF-16（十六进制）** | **UTF32（十六进制）** |
| --------------- | --------------------- | ---------------------- | --------------------- |
| 0x006C49        | E6 B1 89              | 6C 49                  | 00 00 6C 49           |

你会发现，在书写顺序同样为`从左到右`的情况下，把字节的书写顺序由`从高位字节到低位字节`变成了`从低位字节到高位字节`也是可行的，只要在识别时把最右边的字节作为最高位字节，就能够正确解读字符编码：

| **Unicode编号** | **UTF-8（二进制）**        | **UTF-16（二进制）** | **UTF32（二进制）**                 |
| --------------- | -------------------------- | -------------------- | ----------------------------------- |
| 0x006C49        | 10001001 10110001 11100110 | 01001001‬ 0‭1101100    | 01001001‬ 0‭1101100 00000000 00000000 |

| **Unicode编号** | **UTF-8（十六进制）** | **UTF-16（十六进制）** | **UTF32（十六进制）** |
| --------------- | --------------------- | ---------------------- | --------------------- |
| 0x006C49        | 89 B1 E6              | 49 6C                  | 49 6C 00 00           |

尽管字节的顺序变了，但字节内部的比特顺序并未发生改变，这导致最右边的字节是最高位字节，但字节中最左边的比特是最高位比特。这会显得尤为奇怪，于是我们可以把比特顺序也转换了：

| **Unicode编号** | **UTF-8（二进制）**        | **UTF-16（二进制）** | **UTF32（二进制）**                 |
| --------------- | -------------------------- | -------------------- | ----------------------------------- |
| 0x006C49        | 10010001 10001101 01100111 | 10010010 00110110‬    | 10010010 00110110 00000000 00000000‬ |

转换后，字符编码的字节顺序就和比特顺序相同了。

到这里，我们已经发现了问题的所在：

> - 对于多字节字符编码，按照一定的存储顺序，**既可以高位字节在前，也可以低位字节在前**，只有正确识别高低位字节的顺序，才能正确解码
> - 对于字符编码字节而言，按照一定的存储顺序，**既可以高位比特在前，也可以低位比特在前**，只有正确识别高低位比特的顺序，才能正确解码

为了解决这个问题，引入 **字节序** 和 **比特序** 的概念：

> 设存储顺序为**低**内存地址到**高**内存地址（或字节流**首部**到字节流**尾部**）
>
> `注意：如果计算机用虚拟内存空间映射物理内存，那么这里的内存地址指的是虚拟内存地址`
>
> ***大端字节序（Big Endian，BE）：***高位字节优先
>
> ***小端字节序（Little Endian，LE）：***低位字节优先
>
> ***大端比特序（Big Endian，BE）：***一个字节中，高位比特优先
>
> ***小端比特序（Little Endian，LE）：***一个字节中，低位比特优先

字节序不仅存在于字符编码中，也存在于其他编码中，例如：

> 对于**整数的二进制编码**，如果二进制编码超过一个字节，那么类似地，也存在字节序

比特序存在于所有编码中，**只要有字节，就有比特序**。

每台计算机都有默认的字节序和比特序。计算机默认字节序和比特序取决于 CPU 架构：

> 常见的**小端字节序 CPU**包括：
>
> - Intel
> - DEC
>
> 常见的**大端字节序 CPU**包括：
>
> - Motorola 680x0
> - Sun Sparc
> - IBM（例如 Powerpc）
>
> MIPS 和 ARM 可以配置两种字节序中的**任一种**。
>
> CPU 比特序与 CPU 字节序一致。

在某些编码过程中，可以不按照 CPU 字节序进行编码，例如：

> ***就字符编码而言：***
>
> 对于 UTF-16 编码与 UTF-32 编码，可以指定编码为 BE 版本还是 LE 版本：
>
> - UTF-16LE
> - UTF-16BE
> - UTF-32LE
> - UTF-32BE
>
> 对于 UTF-8 编码，不存在显式指定的 LE、BE 版本（只有 UTF-8 编码，没有 UTF-8LE 或 UTF-8BE 编码），这意味着 UTF-8 编码可能是大端字节序，也可能是小端字节序。
>
> 但无论 UTF-8 编码使用大端字节序还是小端字节序，由于 UTF-8 编码的格式比较特殊，都很容易通过编码本身推断出大小端模式。
>
> ***就整数的二进制编码而言：***
>
> 可以使用高级语言中的函数进行 LE、BE 版本的转换，以 C 语言为例：
>
> - ntohl() 函数，将一个无符号整形数从网络字节序转换为主机字节序， ntohl() 返回一个以主机字节序表达的数。`uint32_t ntohl(uint32_t netlong);`
> - htonl() 函数，将一个无符号整形数从主机字节序转换为网络字节序， htonl() 返回一个以网络字节序表达的数。`uint32_t htonl(uint32_t hostlong);`
>
> **注：**网络字节顺序是TCP/IP中规定好的一种数据表示格式，它与具体的CPU类型、操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释。网络字节顺序采用big endian（大端）排序方式。

不同于字节序，**在同一台机器上，只存在一种比特序，那就是 CPU 比特序**。

通过网络在不同的机器间传输数据，网络传输流中的比特序是统一的，由网络协议规定。数据从发送端机器发出时，由网卡负责把机器比特序转换为网络比特序，接收端机器接收数据时，也由网卡负责把网络比特序转换为机器比特序。

如此一来，在编写程序处理数据时，就无需考虑比特序，也不会造成混乱。

## BOM 标记

根据 Unicode 标准的建议，可以在字节流的**头部**（例如文本文件的**头部**）加上 BOM 标记（一个特定的 Unicode 字符）用以表明字节流的编码方式。

> ***BOM：***Byte Order Mark

BOM 标记使用一个 Unicode 字符，以及两个个未定义的 Unicode 码位来表明大小端模式。在 Unicode 字符集中：

- 0xFEFF 码位是一个叫作 **“零宽无中断空格”** 的字符，这个字符代表 UTF-16 编码和 UTF-32 编码的大端字节序；
- 0xFFFE 码位是一个未定义码位，代表 UTF-16 编码的小端字节序；
- 0xFFFE0000 码位超出了 Unicode 字符集的范围，是一个不存在的码位，代表 UTF-32 编码的小端字节序

BOM 标记的用法如下：

> 对于用 UTF-16 编码的使用 BOM 标记的文件，如果文件的前两个字节编码是 `FF FE` ，**根据 UTF-16 编码规则**可以推导出文件的 BOM 标记的 Unicode 码位是 0xFFFE，说明文件编码是小端字节序 LE
>
> 对于用 UTF-16 编码的使用 BOM 标记的文件，如果文件的前两个字节编码是 `FE FF` ，**根据 UTF-16 编码规则**可以推导出文件的 BOM 标记的 Unicode 码位是 0xFEFF，说明文件编码是大端字节序 BE
>
> 对于用 UTF-32 编码的使用 BOM 标记的文件，如果文件的前四个字节编码是 `FF FE 00 00` ，**根据 UTF-32 编码规则**可以推导出文件的 BOM 标记的 Unicode 码位是 0xFFFE0000，说明文件编码是小端字节序 LE
>
> 对于用 UTF-32 编码的使用 BOM 标记的文件，如果文件的前四个字节编码是 `00 00 FE FF` ，**根据 UTF-32 编码规则**可以推导出文件的 BOM 标记的 Unicode 码位是 0xFEFF，说明文件编码是大端字节序 BE
>
> 对于 UTF-8 编码的文件，无需使用 BOM 标记，但有些软件创建 UTF-8 文件时会加上 BOM 标记，UTF-8 编码的文件 BOM 标记统一为 —— 文件的前三个字节编码 `EF BB BF` 
>
> **不含 BOM 的 UTF-8 才是标准形式，在 UTF-8 文件中放置 BOM 主要是微软的习惯（顺便提一下：把带有 BOM 的小端序 UTF-16 称作 「Unicode」 而又不详细说明，这也是微软的习惯）。**

## C语言中的字符编码

下面介绍C语言编程中涉及到的有关字符编码的内容。在下文中，如果提到了`C语言中的字符和字符串`，指的是：

> ***C语言中的字符：***用单引号括起来的字符字面量，例如 `'汉'`
>
> ***C语言中的字符串：***用双引号括起来的字符字面量序列，例如 `"汉字"`

## C语言中的 char 类型常（变）量

在C语言中，char 类型常（变）量的本质是**整数常（变）量**，也即是说，char 类型其实是一种整数类型

而C语言中的字符、字符串的本质是**整数**、**整数数组**，从 `字符、字符串` 到 `整数、整数数组` 的转换是在**程序编译期间**完成的

## C语言中的源字符集和执行字符集

在编译C语言程序时可以设置源字符集和执行字符集

> ***源字符集：***源文件所使用的**字符编码方案**。只有正确设置`源字符集`，编译器才能 “读懂” 源文件中的代码，才能进一步分析、转换、编译。 `对于gcc，可以使用 -finput-charset 编译选项指定源字符集`
>
> Set the input character set, used for translation from the character set of the input file to the source character set used by GCC. If the locale does not specify, or GCC cannot get this information from the locale, the default is UTF-8. This can be overridden by either the locale or this command-line option. Currently the command-line option takes precedence if there’s a conflict. charset can be any encoding supported by the system’s `iconv` library routine.        —— GCC Document
>
> ***执行字符集：***编译器会把源代码中的字符、字符串按照`执行字符集`指定的**字符编码方案**编码成二进制数（组），从而实现由字符到整数、由字符串到整数数组的转换。在这种转换中，字符编码充当了 “桥梁”。`对于gcc，可以使用 -fexec-charset 编译选项指定源字符集`
>
> Set the execution character set, used for string and character constants. The default is UTF-8. charset can be any encoding supported by the system’s `iconv` library routine.        —— GCC Document

C语言不对源字符集、执行字符集做限制，但对源字符集和执行字符集有**最低要求**。

C语言对源字符集和执行字符集的最低要求之一是关于它们的字符集**所包含的字符范围**的要求：

> 源字符集和执行字符集必须**都**包含以下字符：
>
> - 26个大写英文字母
>
> - 26个小写英文字母
>
> - 10个十进制数字字符：`0 1 2 3 4 5 6 7 8 9`
>
> - 29个图形字符：
>
> 	`! " # % & ' ( ) * + , - . / : ; < = > ? [ \ ] ^ _ { | } ~`
>
> - 空格
>
> - 水平制表符
>
> - 垂直制表符
>
> - 换页符
>
> - 空字符
>
> 执行字符集还必须包含：
>
> - 警报
> - 退格
> - 回车
> - 换行（new line）

C语言还要求源字符集和执行字符集编码上述字符得到的字符编码长度必须是**一个字节**

同时，C语言要求不管是在源字符集中，还是在执行字符集中，从字符 ‘0’ 开始，一直到 ‘9’，它们的二进制编码的**值大小必须是依次递增的**

## C语言中的字符、字符串

让我们先来看几个概念：

> ***单字节字符：***如果一个字符按照某种字符编码方案编码成的字符编码**长度为一个字节**，那么称这个字符是单字节字符
>
> ***多字节字符：***如果一个字符按照某种字符编码方案编码成的字符编码**长度大于一个字节**，那么称这个字符是多字节字符
>
> ***宽字符：***如果一个字符按照某种字符编码方案编码成的字符编码与所有其他按照这种编码方案编码的字符的字符编码**长度都一样**且**大于一个字节**，那么称这个字符是宽字符
>
> <u>显然，一个字符是单字节字符、多字节字符还是宽字符，取决于它使用的字符编码方案</u>
>
> ***单字节编码方案：***字符编码长度为**一个字节**的字符编码方案
>
> ***定长编码方案：***字符编码长度**固定**的字符编码方案。典型的定长编码方案是 UTF-32
>
> ***变长编码方案：***字符编码长度**不定**的字符编码方案。典型的变长编码方案是 UTF-8，UTF-8 编码根据字符不同将字符编码成 1~4 字节的字符编码
>
> ***单字节字符串：***按照某种字符编码方案，如果字符串中所有的字符的字符编码长度都是**一个字节**，那么称这个字符串是单字节字符串
>
> ***多字节字符串：***按照某种字符编码方案，如果字符串中包含了字符编码长度**大于一个字节**的字符，那么称这个字符串是多字节字符串
>
> ***宽字符串：***按照某种字符编码方案，如果字符串中**所有的字符都是宽字符**，那么称这个字符串是宽字符串
>
> <u>显然，一个字符串是单字节字符串、多字节字符串还是宽字符串，取决于它使用的字符编码方案</u>

在传统的C语言里，“字符” 其实是**单字节字符**，“字符串” 其实是**单字节字符串**。所以，在传统的C语言中，源字符集和执行字符集指定的编码方案必须是**单字节编码方案**。

> 在这种情况下，C语言规定了一种特殊的整数类型 —— char 类型。
>
> char 类型的长度与传统意义上的 “字符” 的字符编码长度一致，即**一个字节**。显然，char 类型就是为容纳传统意义上的 “字符” 而生的。
>
> 传统意义上的 “字符” 使用 char 类型存储，而 “字符串” 则使用 char 类型的数组存储。
>
> 对于字符串，编译器会在字符串的末尾自动加上一个`空字符`，用以标记字符串的结束。C语言并不会检查用于存储字符串的 char 类型数组大小是否足够容纳字符串，字符串在编译期间会通过字符编码转换成`整数数组`（空字符也包括在内），如果 char 类型的数组的大小不足以容纳这个整数数组，那么这个整数数组多出的一部分就会丢失，也即是说，**包括空字符在内的字符串就会缺失**。

传统的C标准库也是针对`单字节字符`和`单字节字符串`编写的。

在C语言刚问世的时候，单字节编码方案还是主流，多字节字符还未流行起来，这样的安排恰到好处。

但是在C语言问世后的几年到十几年间，多字节字符变得十分流行，很多国家和地区的人们都在工作和生活中使用多字节字符。C语言的国际化势在必行。

C语言的国际化是从C89开始的。C语言对国际化的支持包括：

1. 支持在**注释、字符、字符串和头文件名**中使用多字节字符，这意味着可以将源字符集和执行字符集指定成可以编码多字节字符的编码方案。但由于要符合C语言对源字符集和执行字符集的最低要求，显然，源字符集只能采用**变长编码方案**。

  > - 对于单字节字符串和多字节字符串，编译器都会在字符串的末尾自动加上一个`空字符`，用以标记字符串的结束。
  >
  > - C语言引入对多字节字符的支持后，并未引入新的类型用以容纳多字节字符，因此：
  >
  > 	`如果想要正确存储多字节字符或多字节字符串，就要特别注意，使用足够长的整数类型，以及足够长的整数类型数组`
  >
  > - 引入对多字节字符的支持后，必须在标准库中引入新的函数以支持多字节字符、多字节字符串的编程工作：
  >
  > 	`从C89开始，C标准库中增加了传统单字节字符操纵函数的并行版本（在头文件<wchar.h>和<ctype.h>中声明），用于处理多字节字符`

2. 对宽字符、宽字符串的支持也十分重要，虽然C语言不支持将源字符集或执行字符集指定为定长编码方案，但C语言支持将部分 “字符” 和 “字符串” 编码成`宽字符`和`宽字符串`。这意味着可以为需要编码成宽字符或宽字符串的字符、字符串额外指定`定长编码方案`，它们在程序编译期间将按照指定的定长编码方案进行字符编码。`对于gcc，可以使用 -fwide-exec-charset 编译选项指定用于宽字符和宽字符串的定长编码方案`

    Set the wide execution character set, used for wide string and character constants. The default is UTF-32 or UTF-16, whichever corresponds to the width of `wchar_t`. As with -fexec-charset, charset can be any encoding supported by the system’s `iconv` library routine; however, you will have problems with encodings that do not fit exactly in `wchar_t`.        —— GCC Document

> - 不同于单字节字符串和多字节字符串，对于宽字符串，编译器会在字符串的末尾自动加上一个`空宽字符`，用以标记字符串的结束。`空宽字符`和`空字符`的区别在于，按照源字符集和执行字符集的最低要求，`空字符`的字符编码长度是**一个字节**，而`空宽字符`的字符编码长度**与其他宽字符是一样的**。
>
> - 从C89开始，C语言引入了新的类型`wchar_t`用以容纳宽字符，在C11中，又引入了`char16_t`和`char32_t`。`wchar_t`、`char16_t`、`char32_t`都是比 char 类型更长的整数类型，其中`wchar_t`是编译器预定义的宏，在不同的编译器中，`wchar_t`对应`char16_t`或`char32_t`。`char16_t`的长度是**16位**，`char32_t`的**32位**。
>
> 	`如果想要正确存储宽字符或宽字符串，就应选择足够长的整数类型，以及足够长的整数类型数组`
>
> - 引入对宽字符的支持后，必须在标准库中引入新的函数以支持宽字符、宽字符串的编程工作：
>
> 	`从C89开始，C标准库中增加了传统单字节字符操纵函数的并行版本（在头文件<wchar.h>和<ctype.h>中声明），用于处理宽字符`

虽然可以通过编译选项指定用于编码宽字符、宽字符串的定长编码方案，但**不建议这样做**。原因是C标准库中的宽字符（串）版本的函数工作时并不会以编译选项中指定的定长编码方案为准，而会以 `wchar_t`（代表 **UTF-16** 或 **UTF-32** 编码方案）、`char16_t`（代表 **UTF-16** 编码方案）、`char32_t`（代表 **UTF-32** 编码方案）为准

## C语言中的字符前缀、字符串前缀

C语言支持在字符前使用前缀，`字符前缀`用于标记**宽字符**。

- L

    带有`L`前缀的字符（例如`L'龙'`）在程序编译期间使用**通过编译选项指定的**或**（如果未通过编译选项指定）编译器默认的**定长编码方案进行字符编码

- u

    如果编译器预定义了值为1的`__STD_UTF_16__`宏，带有`u`前缀的字符（例如`u'龙'`）在程序编译期间使用 **UTF-16** 定长编码方案进行字符编码，否则使用的编码方案取决于编译器

- U

    如果编译器预定义了值为1的`__STD_UTF_32__`宏，带有`U`前缀的字符（例如`U'龙'`）在程序编译期间使用 **UTF-32** 定长编码方案进行字符编码，否则使用的编码方案取决于编译器

C语言支持在字符串前使用前缀，`字符串前缀`用于标记 **u8字符串** 和 **宽字符串**。

- u8

    带有`u8`前缀的字符串是**u8字符串**。在程序编译期间**u8字符串**使用 **UTF-8** 编码方案进行字符编码。例如`u8"龙王标识"`

- L

    带有`L`前缀的字符串是**宽字符串**，在程序编译期间使用**通过编译选项指定的**或**（如果未通过编译选项指定）编译器默认的**定长编码方案进行字符编码。例如`L"龙王标识"`

- u

    带有`u`前缀的字符串是**宽字符串**，如果编译器预定义了值为1的`__STD_UTF_16__`宏，在程序编译期间使用 **UTF-16** 定长编码方案进行字符编码，否则使用的编码方案取决于编译器。例如`u"龙王标识"`

- U

    带有`U`前缀的字符串是**宽字符串**，如果编译器预定义了值为1的`__STD_UTF_32__`宏，在程序编译期间使用 **UTF-32** 定长编码方案进行字符编码，否则使用的编码方案取决于编译器。例如`U"龙王标识"`

## C语言对 Unicode 字符集的支持

Unicode 字符集包括了当今世界上使用的绝大部分字符，从C99开始，C语言也提供了对 Unicode 字符集的支持 —— 可以在**标识符**、字符、字符串中使用**统一字符名**，以方便引用 Unicode 字符集中的字符。

> ***统一字符名：***也叫 **通用字符名**。统一字符名由 “**\u**” 引导，后跟4个十六进制数字，例如`\u00A8`；或由 “**\U**” 引导，后跟8个十六进制数字，例如`\U000CFFFD`。无论是`\u`引导的4位十六进制数，还是`\U`引导的8位十六进制数，都是 **Unicode 代码点**。

引入统一字符名有如下好处：

1. 如果用于编写源代码的文本编辑器不支持输入某些 Unicode 字符，可以用统一字符名代替
2. 不同国家或者地区有不同的文化，如果 IDE 提供由 Unicode 字符到统一字符名的自动转换功能，那么不同国家和地区的程序员就能够在标识符中使用他们国家的文字

然而，**并非所有的 Unicode 代码点都可以用于创建标识符**。C标准文档的附录中给出了有关这方面的详细信息。

```c
printf("\u6C49\U00005B57");			//这行代码将打印出 “汉字”
```

## C语言中的脱转序列

> **脱转序列** 也叫 **转义序列**

正如统一字符名用于代替 Unicode 字符一样，**转义序列**是用来代替一些不可见字符（例如`警报`、`空字符`等）和一些特殊字符。

转义序列包括：

- 简单转义序列
- 八进制转义序列
- 十六进制转义序列
- 统一字符名

下面对各种转义序列进行介绍：

1. 简单转义序列（仅罗列一部分）

    | 转义序列 |       含义       |
    | :------: | :--------------: |
    |   \\'    |    英文单引号    |
    |   \\"    |    英文双引号    |
    |   \\\    |    英文反斜杠    |
    |   \\?    |     英文问号     |
    |   \\b    |       退格       |
    |   \\f    |       换页       |
    |   \\n    | 换行（new line） |
    |   \\r    |  回车（return）  |
    |   \\t    |    水平制表符    |
    |   \\v    |    垂直制表符    |
    |   \\0    |      空字符      |

2. 八进制转义序列

    八进制转义序列由反斜杠`\`引导，后跟1~3个八进制数字（例如`\123`）

3. 十六进制转义序列

    十六进制转义序列由`\x`引导，后跟个数不限的十六进制数字（例如`\xabc`）

4. 统一字符名（略，详见上文）

在C语言中，**不推荐**使用八进制转义序列和十六进制转义序列

```c
printf("Hello, world!\n");			//经典的第一行代码中就包含了 “换行” 的转义序列
```

## C语言中的三联序列

**三联序列**与脱转序列十分相似。

三联序列是从C89开始引入的。三联序列使用三个字符的序列来代表一些字符：

| 三联序列 | 含义 |
| :------: | :--: |
|   ??=    |  #   |
|   ??(    |  [   |
|   ??/    |  \   |
|   ??)    |  ]   |
|   ??'    |  ^   |
|   ??<    |  {   |
|   ??!    |  \|  |
|   ??>    |  }   |
|   ??-    |  ~   |

三联序列可以用在源文件中的任何地方，在程序编译的准备阶段，源文件中**所有的**三联序列都会被替换。

## 小结

C语言中，`转义序列`和`三联序列`都是用用于代替某些字符的。

> 转义序列和三联序列的处理都是**不迭代**的。
>
> 也就是说，转义序列`\\\\`被处理之后会被还原成`\\`，而不是`\`。

在处理顺序上，程序编译期间，三联序列的处理要**先于**脱转序列。

利用三联序列和脱转序列，我们可以写出类似如下的代码：

```c
??=include<stdio.h>
    
int main(void)
??<
    printf("Hello, world!??/n");
    return 0;
??>
```

有时候三联序列会和我们希望得到的内容冲突。这时候**用脱转序列来阻止三联序列的形成**是最好的方法。例如，如果想要输出`??!`，就在字符串中放置`?\?!`。

## Windows 控制台字符编码

在某种程度上，Windows控制台像一块触摸屏。

当我们在Windows控制台上运行C程序时，Windows控制台将C程序打印的内容（例如`printf`函数）显示出来；同时我们可以在控制台中输入内容，Windows控制台将用户输入的内容传递给扫描函数（例如`scanf`函数）。

这就涉及到了`输入、输出`的传递。

C程序将`输出`传递给控制台代为打印，而控制台将接收到`用户的输入`传递给C程序。

在传递的过程中，`输入、输出`的内容以**字符编码**的形式进行传递。

显而易见的是，如果C程序和控制台就 “`字符编码方案`” 没有 “`协商`” 好，那么`输入、输出`的编码、解码就会出错，最终导致乱码。

Windows控制台提供了三个 API，用以设置相关字符编码方案：

1. 设置控制台用于**解码**C程序传递给控制台的`输出内容`的字符编码方案：

    ```c
    #include <windows.h>
    SetConsoleOutputCP(wCodePageID);
    ```

2. 设置控制台用于**编码**`用户输入的内容`的字符编码方案：

    ```c
    #include <windows.h>
    SetConsoleCP(wCodePageID);
    ```

3. 可以用一条命令将上述两项设置为同一种编码方案：`chcp wCodePageID`

    ```c
    #include <stdlib.h>
    system("chcp wCodePageID");
    ```

以上代码中出现的`wCodePageID`是**Windows代码页**的编号。

> ***Windows代码页：***`代码页`是字符编码方案在Windows中的别名。Windows给每一种代码页都进行了编号。例如 UTF-8 字符编码方案的代码页编号是 65001，GBK 字符编码方案的代码页编号是 936，而GB2312 字符编码方案的代码页编号则是 20936

更多的代码页编号可以到 [微软官方文档 - 代码页](https://docs.microsoft.com/en-us/windows/win32/intl/code-page-identifiers) 中查询。文末的**附表**为微软官方文档中的`代码页对照表`。

请看代码：

```c
#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

int main(void)
{
    SetConsoleCP(936);
    SetConsoleOutputCP(936);
    char name[100] = {0};
    printf("请输入您的名字：");
    scanf("%s" , name);
    printf("\n您好，%s！欢迎使用！\n\n" , name);
    system("pause");
    return 0;
}
```

编译选项：

```powershell
gcc -finput-charset=<保存源文件时使用的字符编码> -fexec-charset=GBK <源文件名>
```

运行结果：

```
请输入您的名字：特里

您好，特里！欢迎使用！

请按任意键继续. . .
```

> **Warning：**
>
> Windows控制台已知`bug`：无法从控制台正确读取编码为 UTF-8 的用户输入。也就是说，如果使用了`SetConsoleCP(65001)`或`chcp 65001`，将无法正确接收用户输入的内容。

## 后记

了解了这许多关于字符编码的知识，你能够解释前言中提到的各种现象了吗？

让我们一起看一看：

```c
#include <stdio.h>
#include <stdlib.h>

int main(void)
{
    printf("Hello, world!\n");   //鎴戠殑绗竴涓▼搴
    printf("鎴戞槸灏忔槑\n");
    system("pause");
    return 0;
}
```

导致上面这种现象的原因是：打开源文件时使用的字符编码方案与保存源文件时使用的字符编码方案不同

```
Hello, world!
浣犲ソ锛屼笘鐣岋紒
```

上面这段应该是某个控制台程序的输出，造成乱码的原因有多种可能。为了解决类似的乱码问题，需要确保以下几点：

- `保存源文件`时使用的字符编码方案和编译程序时使用的`源字符集`**保持一致**
- 编译程序时使用的`执行字符集`和控制台的`输出编码`（使用 `SetConsoleOutputCP()` 函数或 `chcp` 命令设置）**保持一致**
- 控制台的`输出编码`和控制台的`输入编码`（使用 `SetConsoleCP()` 函数或 `chcp` 命令设置）**保持一致**
- **不要**将控制台的`输入编码`设置为 UTF-8（**Windows控制台 bug**）

```
abcdef烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫烫
```

有很多人认为出现这一连串的 “烫” 是出现了乱码，这其实是一个误会。

某些编译器会把未初始化的**栈空间**（一般对应**局部变量**）用 `0xCC` 填充，而 `0xCC` 按照GBK解码得到 “烫” 字。

所以如果你打印出了一连串的 “烫”，那多半是你把**未初始化的变量或数组**打印出来了

```
123456屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯屯
```

类似于上面那个例子，某些编译器会把未初始化的**堆空间**（一般对应使用 `malloc()` 等函数申请的**动态内存**）用 `0xCD` 填充，而 `0xCD` 按照GBK解码得到 “屯” 字。

所以如果你打印出了一连串的 “屯”，那多半是你把**未初始化的动态内存**打印出来了

## 附表

| 编号  | 字符编码方案名称        | 详细信息                                                     |
| ----- | ----------------------- | ------------------------------------------------------------ |
| 037   | IBM037                  | IBM EBCDIC US-Canada                                         |
| 437   | IBM437                  | OEM United States                                            |
| 500   | IBM500                  | IBM EBCDIC International                                     |
| 708   | ASMO-708                | Arabic (ASMO 708)                                            |
| 709   |                         | Arabic (ASMO-449+, BCON V4)                                  |
| 710   |                         | Arabic - Transparent Arabic                                  |
| 720   | DOS-720                 | Arabic (Transparent ASMO); Arabic (DOS)                      |
| 737   | ibm737                  | OEM Greek (formerly 437G); Greek (DOS)                       |
| 775   | ibm775                  | OEM Baltic; Baltic (DOS)                                     |
| 850   | ibm850                  | OEM Multilingual Latin 1; Western European (DOS)             |
| 852   | ibm852                  | OEM Latin 2; Central European (DOS)                          |
| 855   | IBM855                  | OEM Cyrillic (primarily Russian)                             |
| 857   | ibm857                  | OEM Turkish; Turkish (DOS)                                   |
| 858   | IBM00858                | OEM Multilingual Latin 1 + Euro symbol                       |
| 860   | IBM860                  | OEM Portuguese; Portuguese (DOS)                             |
| 861   | ibm861                  | OEM Icelandic; Icelandic (DOS)                               |
| 862   | DOS-862                 | OEM Hebrew; Hebrew (DOS)                                     |
| 863   | IBM863                  | OEM French Canadian; French Canadian (DOS)                   |
| 864   | IBM864                  | OEM Arabic; Arabic (864)                                     |
| 865   | IBM865                  | OEM Nordic; Nordic (DOS)                                     |
| 866   | cp866                   | OEM Russian; Cyrillic (DOS)                                  |
| 869   | ibm869                  | OEM Modern Greek; Greek, Modern (DOS)                        |
| 870   | IBM870                  | IBM EBCDIC Multilingual/ROECE (Latin 2); IBM EBCDIC Multilingual Latin 2 |
| 874   | windows-874             | ANSI/OEM Thai (ISO 8859-11); Thai (Windows)                  |
| 875   | cp875                   | IBM EBCDIC Greek Modern                                      |
| 932   | shift_jis               | ANSI/OEM Japanese; Japanese (Shift-JIS)                      |
| 936   | gb2312                  | ANSI/OEM Simplified Chinese (PRC, Singapore); Chinese Simplified (GB2312) |
| 949   | ks_c_5601-1987          | ANSI/OEM Korean (Unified Hangul Code)                        |
| 950   | big5                    | ANSI/OEM Traditional Chinese (Taiwan; Hong Kong SAR, PRC); Chinese Traditional (Big5) |
| 1026  | IBM1026                 | IBM EBCDIC Turkish (Latin 5)                                 |
| 1047  | IBM01047                | IBM EBCDIC Latin 1/Open System                               |
| 1140  | IBM01140                | IBM EBCDIC US-Canada (037 + Euro symbol); IBM EBCDIC (US-Canada-Euro) |
| 1141  | IBM01141                | IBM EBCDIC Germany (20273 + Euro symbol); IBM EBCDIC (Germany-Euro) |
| 1142  | IBM01142                | IBM EBCDIC Denmark-Norway (20277 + Euro symbol); IBM EBCDIC (Denmark-Norway-Euro) |
| 1143  | IBM01143                | IBM EBCDIC Finland-Sweden (20278 + Euro symbol); IBM EBCDIC (Finland-Sweden-Euro) |
| 1144  | IBM01144                | IBM EBCDIC Italy (20280 + Euro symbol); IBM EBCDIC (Italy-Euro) |
| 1145  | IBM01145                | IBM EBCDIC Latin America-Spain (20284 + Euro symbol); IBM EBCDIC (Spain-Euro) |
| 1146  | IBM01146                | IBM EBCDIC United Kingdom (20285 + Euro symbol); IBM EBCDIC (UK-Euro) |
| 1147  | IBM01147                | IBM EBCDIC France (20297 + Euro symbol); IBM EBCDIC (France-Euro) |
| 1148  | IBM01148                | IBM EBCDIC International (500 + Euro symbol); IBM EBCDIC (International-Euro) |
| 1149  | IBM01149                | IBM EBCDIC Icelandic (20871 + Euro symbol); IBM EBCDIC (Icelandic-Euro) |
| 1200  | utf-16                  | Unicode UTF-16, little endian byte order (BMP of ISO 10646); available only to managed applications |
| 1201  | unicodeFFFE             | Unicode UTF-16, big endian byte order; available only to managed applications |
| 1250  | windows-1250            | ANSI Central European; Central European (Windows)            |
| 1251  | windows-1251            | ANSI Cyrillic; Cyrillic (Windows)                            |
| 1252  | windows-1252            | ANSI Latin 1; Western European (Windows)                     |
| 1253  | windows-1253            | ANSI Greek; Greek (Windows)                                  |
| 1254  | windows-1254            | ANSI Turkish; Turkish (Windows)                              |
| 1255  | windows-1255            | ANSI Hebrew; Hebrew (Windows)                                |
| 1256  | windows-1256            | ANSI Arabic; Arabic (Windows)                                |
| 1257  | windows-1257            | ANSI Baltic; Baltic (Windows)                                |
| 1258  | windows-1258            | ANSI/OEM Vietnamese; Vietnamese (Windows)                    |
| 1361  | Johab                   | Korean (Johab)                                               |
| 10000 | macintosh               | MAC Roman; Western European (Mac)                            |
| 10001 | x-mac-japanese          | Japanese (Mac)                                               |
| 10002 | x-mac-chinesetrad       | MAC Traditional Chinese (Big5); Chinese Traditional (Mac)    |
| 10003 | x-mac-korean            | Korean (Mac)                                                 |
| 10004 | x-mac-arabic            | Arabic (Mac)                                                 |
| 10005 | x-mac-hebrew            | Hebrew (Mac)                                                 |
| 10006 | x-mac-greek             | Greek (Mac)                                                  |
| 10007 | x-mac-cyrillic          | Cyrillic (Mac)                                               |
| 10008 | x-mac-chinesesimp       | MAC Simplified Chinese (GB 2312); Chinese Simplified (Mac)   |
| 10010 | x-mac-romanian          | Romanian (Mac)                                               |
| 10017 | x-mac-ukrainian         | Ukrainian (Mac)                                              |
| 10021 | x-mac-thai              | Thai (Mac)                                                   |
| 10029 | x-mac-ce                | MAC Latin 2; Central European (Mac)                          |
| 10079 | x-mac-icelandic         | Icelandic (Mac)                                              |
| 10081 | x-mac-turkish           | Turkish (Mac)                                                |
| 10082 | x-mac-croatian          | Croatian (Mac)                                               |
| 12000 | utf-32                  | Unicode UTF-32, little endian byte order; available only to managed applications |
| 12001 | utf-32BE                | Unicode UTF-32, big endian byte order; available only to managed applications |
| 20000 | x-Chinese_CNS           | CNS Taiwan; Chinese Traditional (CNS)                        |
| 20001 | x-cp20001               | TCA Taiwan                                                   |
| 20002 | x_Chinese-Eten          | Eten Taiwan; Chinese Traditional (Eten)                      |
| 20003 | x-cp20003               | IBM5550 Taiwan                                               |
| 20004 | x-cp20004               | TeleText Taiwan                                              |
| 20005 | x-cp20005               | Wang Taiwan                                                  |
| 20105 | x-IA5                   | IA5 (IRV International Alphabet No. 5, 7-bit); Western European (IA5) |
| 20106 | x-IA5-German            | IA5 German (7-bit)                                           |
| 20107 | x-IA5-Swedish           | IA5 Swedish (7-bit)                                          |
| 20108 | x-IA5-Norwegian         | IA5 Norwegian (7-bit)                                        |
| 20127 | us-ascii                | US-ASCII (7-bit)                                             |
| 20261 | x-cp20261               | T.61                                                         |
| 20269 | x-cp20269               | ISO 6937 Non-Spacing Accent                                  |
| 20273 | IBM273                  | IBM EBCDIC Germany                                           |
| 20277 | IBM277                  | IBM EBCDIC Denmark-Norway                                    |
| 20278 | IBM278                  | IBM EBCDIC Finland-Sweden                                    |
| 20280 | IBM280                  | IBM EBCDIC Italy                                             |
| 20284 | IBM284                  | IBM EBCDIC Latin America-Spain                               |
| 20285 | IBM285                  | IBM EBCDIC United Kingdom                                    |
| 20290 | IBM290                  | IBM EBCDIC Japanese Katakana Extended                        |
| 20297 | IBM297                  | IBM EBCDIC France                                            |
| 20420 | IBM420                  | IBM EBCDIC Arabic                                            |
| 20423 | IBM423                  | IBM EBCDIC Greek                                             |
| 20424 | IBM424                  | IBM EBCDIC Hebrew                                            |
| 20833 | x-EBCDIC-KoreanExtended | IBM EBCDIC Korean Extended                                   |
| 20838 | IBM-Thai                | IBM EBCDIC Thai                                              |
| 20866 | koi8-r                  | Russian (KOI8-R); Cyrillic (KOI8-R)                          |
| 20871 | IBM871                  | IBM EBCDIC Icelandic                                         |
| 20880 | IBM880                  | IBM EBCDIC Cyrillic Russian                                  |
| 20905 | IBM905                  | IBM EBCDIC Turkish                                           |
| 20924 | IBM00924                | IBM EBCDIC Latin 1/Open System (1047 + Euro symbol)          |
| 20932 | EUC-JP                  | Japanese (JIS 0208-1990 and 0212-1990)                       |
| 20936 | x-cp20936               | Simplified Chinese (GB2312); Chinese Simplified (GB2312-80)  |
| 20949 | x-cp20949               | Korean Wansung                                               |
| 21025 | cp1025                  | IBM EBCDIC Cyrillic Serbian-Bulgarian                        |
| 21027 |                         | (deprecated)                                                 |
| 21866 | koi8-u                  | Ukrainian (KOI8-U); Cyrillic (KOI8-U)                        |
| 28591 | iso-8859-1              | ISO 8859-1 Latin 1; Western European (ISO)                   |
| 28592 | iso-8859-2              | ISO 8859-2 Central European; Central European (ISO)          |
| 28593 | iso-8859-3              | ISO 8859-3 Latin 3                                           |
| 28594 | iso-8859-4              | ISO 8859-4 Baltic                                            |
| 28595 | iso-8859-5              | ISO 8859-5 Cyrillic                                          |
| 28596 | iso-8859-6              | ISO 8859-6 Arabic                                            |
| 28597 | iso-8859-7              | ISO 8859-7 Greek                                             |
| 28598 | iso-8859-8              | ISO 8859-8 Hebrew; Hebrew (ISO-Visual)                       |
| 28599 | iso-8859-9              | ISO 8859-9 Turkish                                           |
| 28603 | iso-8859-13             | ISO 8859-13 Estonian                                         |
| 28605 | iso-8859-15             | ISO 8859-15 Latin 9                                          |
| 29001 | x-Europa                | Europa 3                                                     |
| 38598 | iso-8859-8-i            | ISO 8859-8 Hebrew; Hebrew (ISO-Logical)                      |
| 50220 | iso-2022-jp             | ISO 2022 Japanese with no halfwidth Katakana; Japanese (JIS) |
| 50221 | csISO2022JP             | ISO 2022 Japanese with halfwidth Katakana; Japanese (JIS-Allow 1 byte Kana) |
| 50222 | iso-2022-jp             | ISO 2022 Japanese JIS X 0201-1989; Japanese (JIS-Allow 1 byte Kana - SO/SI) |
| 50225 | iso-2022-kr             | ISO 2022 Korean                                              |
| 50227 | x-cp50227               | ISO 2022 Simplified Chinese; Chinese Simplified (ISO 2022)   |
| 50229 |                         | ISO 2022 Traditional Chinese                                 |
| 50930 |                         | EBCDIC Japanese (Katakana) Extended                          |
| 50931 |                         | EBCDIC US-Canada and Japanese                                |
| 50933 |                         | EBCDIC Korean Extended and Korean                            |
| 50935 |                         | EBCDIC Simplified Chinese Extended and Simplified Chinese    |
| 50936 |                         | EBCDIC Simplified Chinese                                    |
| 50937 |                         | EBCDIC US-Canada and Traditional Chinese                     |
| 50939 |                         | EBCDIC Japanese (Latin) Extended and Japanese                |
| 51932 | euc-jp                  | EUC Japanese                                                 |
| 51936 | EUC-CN                  | EUC Simplified Chinese; Chinese Simplified (EUC)             |
| 51949 | euc-kr                  | EUC Korean                                                   |
| 51950 |                         | EUC Traditional Chinese                                      |
| 52936 | hz-gb-2312              | HZ-GB2312 Simplified Chinese; Chinese Simplified (HZ)        |
| 54936 | GB18030                 | **Windows XP and later:** GB18030 Simplified Chinese (4 byte); Chinese Simplified (GB18030) |
| 57002 | x-iscii-de              | ISCII Devanagari                                             |
| 57003 | x-iscii-be              | ISCII Bangla                                                 |
| 57004 | x-iscii-ta              | ISCII Tamil                                                  |
| 57005 | x-iscii-te              | ISCII Telugu                                                 |
| 57006 | x-iscii-as              | ISCII Assamese                                               |
| 57007 | x-iscii-or              | ISCII Odia                                                   |
| 57008 | x-iscii-ka              | ISCII Kannada                                                |
| 57009 | x-iscii-ma              | ISCII Malayalam                                              |
| 57010 | x-iscii-gu              | ISCII Gujarati                                               |
| 57011 | x-iscii-pa              | ISCII Punjabi                                                |
| 65000 | utf-7                   | Unicode (UTF-7)                                              |
| 65001 | utf-8                   | Unicode (UTF-8)                                              |